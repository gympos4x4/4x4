// Author: Juraj Marcin

#include "ParkingSensors.h"
#include "../comm.h"

_ParkingSensors ParkingSensors;

void _ParkingSensors::init() {
	pinMode(PS_IR_PIN, OUTPUT);
	eADC::init();
}

int16_t _ParkingSensors::readsensor(int sensor) {
	int16_t high = 0;
	int16_t low = 0;
	if (PS_SENSOR_COUNT > sensor) {
		digitalWrite(PS_IR_PIN, LOW);
		high = eADC::analogRead(sensor);
		digitalWrite(PS_IR_PIN, HIGH);
		low = eADC::analogRead(sensor);
	}
	return high - low;
}

void _ParkingSensors::loop() {
	int16_t highest = 4096;
	for (int i = 0; i < PS_SENSOR_COUNT; i++) {
		int16_t current = readsensor(i);
		sensorData[i] = current;
		if (current > highest) {
			highest = current;
		}
	}
}

void _ParkingSensors::update_cardata(CarData& cardata)
{
	for(int i = 0; i < PS_SENSOR_COUNT; i++)
		cardata.parking.sensor_data[i] = sensorData[i];
}

